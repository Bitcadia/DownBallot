<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="//rawgithub.com/phpepe/highcharts-regression/master/highcharts-regression.js"> </script>
<style>
</style>

<figure class="highcharts-figure">
    <form action="./StraightIndividualRatioCompare.html">
        <label for="First">Compare (comma separated)</label>
        <input id="First" name="First" type="text" />
        <label for="Second">Filter By Split Ballot Ratio</label>
        <input id="Second" name="Second" type="number" step="0.01" />
        <input type="submit" value="Submit">
    </form>
    <div id="container"></div>
</figure>
<script>
    (function (doc, win, add, remove, loaded, load) {
        doc.ready = new Promise(function (resolve) {
            if (doc.readyState === 'complete') {
                resolve();
            } else {
                function onReady() {
                    resolve();
                    doc[remove](loaded, onReady, true);
                    win[remove](load, onReady, true);
                }
                doc[add](loaded, onReady, true);
                win[add](load, onReady, true);
            }
        });
    })(document, window, 'addEventListener', 'removeEventListener', 'DOMContentLoaded', 'load');
    (async () => {
        await document.ready;
        const urlParams = new URLSearchParams(window.location.search);
        const first = urlParams.get('First') || "AL,AZ,AR,CA,CO,CT,DE,FL,GA,HI,ID,IL,IN,IA,KS,KY,LA,ME,MD,MA,MI,MN,MS,MO,MT,NE,NV,NH,NJ,NM,NY,NC,ND,OH,OK,OR,PA,RI,SC,SD,TN,TX,UT,VT,VA,WA,WV,WI,WY";
        const second = urlParams.get('Second') || 2;
        document.querySelector("#First").value = first;
        document.querySelector("#Second").value = second;
        const firstFilter = first.split(",");
        const secondFilter = parseFloat(second.toString());
        const fetching = await fetch("./StraightIndividualRatio.json");
        const data = JSON.parse(await fetching.text());
        const node = document.createElement("div");
        node.id = `Compare`;
        document.querySelector("#container").appendChild(node);
        Highcharts.chart(node.id, {
            chart: {
                height: "75%",
                type: 'bubble',
                plotBorderWidth: 1,
                zoomType: 'xy'
            },
            title: {
                text: `Ratio of split ballots`
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: '% Straight Ballot Leans'
                },
                min: -100,
                max: 100,
                startOnTick: true,
                endOnTick: true,
                showLastLabel: true
            },
            yAxis: {
                title: {
                    text: '% Non-Party Line Voters'
                },
                max: 400
            },
            legend: {
                layout: 'horizontal',
                backgroundColor: Highcharts.defaultOptions.chart.backgroundColor,
                borderWidth: 1
            },
            plotOptions: {
                series: {
                    dataLabels: {
                        enabled: true,
                        format: '{point.name}'
                    }
                }
            },
            series: [{
                name: "Trump",
                color: 'rgb(255,0,0)',
                data: firstFilter.reduce((acc, state) => {
                    acc.push(...data.TrumpDownStraightIndividualRatio[state].filter((val)=>val[3] > secondFilter).map((val) => {
                        return {
                            x: 2 * (val[0] - 50),
                            y: val[1],
                            z: val[2],
                            name: `${state}-${val[4]}-${val[3].toPrecision(3)}x`,
                        };
                    }));
                    return acc;
                }, [])
            }, {
                name: "Biden",
                color: 'rgba(0,0,255,0.1)',
                data: firstFilter.reduce((acc, state) => {
                    acc.push(...data.BidenDownStraightIndividualRatio[state].filter((val)=>val[3] > secondFilter).map((val) => {
                        return {
                            x: -2 * (val[0] - 50),
                            y: val[1],
                            z: val[2],
                            name: `${state}-${val[4]}-${val[3].toPrecision(3)}x`,
                        };
                    }));
                    return acc;
                }, [])
            }]
        });
    })()

</script>